#!/bin/bash

################################################################################
# 文件名: validator.sh
# 功能: 输入验证函数 - 格式验证、安全检查
# 依赖: 无
################################################################################

################################################################################
# 函数名: is_test
# 功能: 验证输入数据的格式和有效性
# 参数:
#   $1 - 验证类型 (number|port|port_used|domain|path|uuid)
#   $2 - 要验证的值
# 返回: 验证通过输出 "ok",否则无输出
# 说明:
#   - number: 验证是否为正整数 (1-99+)
#   - port: 验证端口号 (1-65535)
#   - port_used: 检查端口是否被占用
#   - domain: 验证域名格式
#   - path: 验证路径格式
#   - uuid: 验证 UUID 格式
# 示例:
#   is_test port 8080 && echo "端口格式有效"
#   is_test uuid "123e4567-e89b-12d3-a456-426614174000" && echo "UUID 有效"
################################################################################
is_test() {
    case $1 in
    number)
        # 验证是否为正整数 (1-99+)
        echo $2 | grep -E '^[1-9][0-9]?+$'
        ;;
    port)
        # 验证端口号范围 (1-65535)
        if [[ $(is_test number $2) ]]; then
            [[ $2 -le 65535 ]] && echo ok
        fi
        ;;
    port_used)
        # 检查端口是否被占用
        [[ $(is_port_used $2) && ! $is_cant_test_port ]] && echo ok
        ;;
    domain)
        # 验证域名格式
        # 格式: 字母数字开头,可包含点和短横线,以字母结尾
        echo $2 | grep -E -i '^\w(\w|\-|\.)?+\.\w+$'
        ;;
    path)
        # 验证路径格式
        # 格式: 以 / 开头,包含字母数字短横线和斜杠
        echo $2 | grep -E -i '^\/\w(\w|\-|\/)?+\w$'
        ;;
    uuid)
        # 验证 UUID 格式
        # 格式: 8-4-4-4-12 (十六进制)
        echo $2 | grep -E -i '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}'
        ;;
    esac
}

################################################################################
# 函数名: validate_port
# 功能: 验证端口号是否有效 (独立函数形式)
# 参数: $1 - 端口号
# 返回: 0 表示有效,1 表示无效
# 示例: validate_port 8080 && echo "端口有效"
################################################################################
validate_port() {
    local port=$1
    [[ $port =~ ^[0-9]+$ ]] || return 1
    [[ $port -ge 1 && $port -le 65535 ]] || return 1
    return 0
}

################################################################################
# 函数名: validate_uuid
# 功能: 验证 UUID 格式是否正确 (独立函数形式)
# 参数: $1 - UUID 字符串
# 返回: 0 表示有效,1 表示无效
# 示例: validate_uuid "123e4567-e89b-12d3-a456-426614174000" && echo "UUID 有效"
################################################################################
validate_uuid() {
    local uuid=$1
    [[ $uuid =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]] || return 1
    return 0
}

################################################################################
# 函数名: validate_domain
# 功能: 验证域名格式是否正确 (独立函数形式)
# 参数: $1 - 域名
# 返回: 0 表示有效,1 表示无效
# 示例: validate_domain "example.com" && echo "域名有效"
################################################################################
validate_domain() {
    local domain=$1
    [[ $domain =~ ^([a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$ ]] || return 1
    return 0
}

################################################################################
# 函数名: validate_path
# 功能: 验证路径格式是否正确 (独立函数形式)
# 参数: $1 - 路径
# 返回: 0 表示有效,1 表示无效
# 说明: 路径必须以 / 开头,不允许特殊字符
# 示例: validate_path "/api/v1" && echo "路径有效"
################################################################################
validate_path() {
    local path=$1
    # 检查路径格式
    [[ $path =~ ^/[a-zA-Z0-9_/-]+$ ]] || return 1
    # 禁止特殊字符,防止命令注入
    [[ $path =~ [;\&\|\$\`] ]] && return 1
    return 0
}
