# src 目录功能文件优化建议

基于对 `src` 目录内脚本的深度分析，以下从**安全性、架构设计、健壮性、用户体验**四个维度提出优化建议。

## 1. 安全性优化 (Security)

### 1.1 下载完整性校验 (`download.sh`)
*   **当前问题**：目前脚本直接从 GitHub Release 下载二进制文件，未进行完整性校验。如果下载过程中被劫持或文件损坏，可能导致运行失败甚至安全风险。
*   **建议**：
    *   在下载 release 的同时，下载 `sha256sum` 校验文件。
    *   下载完成后，自动比对本地文件的 Hash 值，校验通过后再进行安装。

### 1.2 最小权限原则 (`systemd.sh`)
*   **当前问题**：`sing-box.service` 和 `caddy.service` 默认使用 `User=root` 运行。
*   **建议**：
    *   创建专用的系统用户（如 `sing-box` 和 `caddy`）。
    *   在 systemd 配置中使用 `User=sing-box` 和 `Group=sing-box`。
    *   确保相关目录（配置文件、日志目录）的所有权正确移交给该非特权用户。
    *   如果需要绑定 80/443 端口，利用 `AmbientCapabilities=CAP_NET_BIND_SERVICE` 而非直接用 root。

### 1.3 输入验证增强 (`core.sh`)
*   **当前问题**：虽然 `ask` 函数有基本的端口和 UUID 格式检查，但对于自定义输入（如 path, domain）的过滤可能不够严格，存在注入风险。
*   **建议**：
    *   对所有用户输入进行更严格的正则校验，禁止特殊字符（如 `;`, `&`, `|` 等 Shell 元字符），防止命令注入。

## 2. 架构与代码质量 (Architecture & Maintainability)

### 2.1 核心逻辑拆分 (`core.sh`)
*   **当前问题**：`core.sh` 文件体积庞大（1700+行），包含了菜单逻辑、各个协议的配置生成、CRUD 操作等，属于“上帝对象”。
*   **建议**：
    *   **按协议拆分**：将 `VMess`, `VLESS`, `Trojan`, `Shadowsocks` 等协议的生成逻辑拆分到单独的文件中（如 `src/protocols/vmess.sh`）。
    *   **逻辑分层**：将 UI 交互（菜单、输入）与 业务逻辑（生成配置、重启服务）分离。

### 2.2 统一配置管理 (`init.sh`)
*   **当前问题**：全局变量散落在 `init.sh` 中，且部分变量未设为只读。
*   **建议**：
    *   使用 `readonly` 关键字定义常量（如版本号、路径），防止运行时意外修改。
    *   将所有可配置项（如默认端口范围、API URL）提取到一个单独的 `config.env` 文件中，方便维护。

### 2.3 错误处理标准化 (`init.sh`, `core.sh`)
*   **当前问题**：脚本中多处使用了 `exit 1` 或直接 `return`，缺乏统一的错误捕获栈。
*   **建议**：
    *   引入 `trap` 机制捕获 `ERR` 信号，打印错误发生的行号和上下文。
    *   考虑在关键操作（如文件写入）时开启 `set -e`，确保原子性。

## 3. 健壮性与稳定性 (Robustness)

### 3.1 外部依赖容灾 (`core.sh`, `download.sh`)
*   **当前问题**：
    *   `get_ip` 仅依赖 `one.one.one.one`。
    *   下载仅依赖 GitHub API。
*   **建议**：
    *   **多源 IP 获取**：增加备用接口（如 `ip.sb`, `ifconfig.me`），构建轮询获取机制。
    *   **下载镜像加速**：提供国内/多区域镜像源选项（如 `ghproxy` 或自定义 CDN），解决 GitHub 连接不稳定的问题。

### 3.2 配置备份与回滚 (`core.sh`)
*   **当前问题**：修改配置（如 `change` 命令）时直接覆盖原文件，若生成错误可能导致服务不可用。
*   **建议**：
    *   在写入新 JSON 之前，先将旧的 `.json` 文件备份到 `backup/` 目录。
    *   新配置写入后，先运行 `sing-box check -c new.json` 进行语法验证，验证通过后再应用并重启服务；验证失败则自动回滚。

## 4. 用户体验 (UX)

### 4.1 进度可视化 (`download.sh`)
*   **当前问题**：使用 `wget` 或 `curl` 下载时，输出可能不够直观或被重定向干扰。
*   **建议**：
    *   封装统一的下载函数，显示简化的进度条。

### 4.2 智能检测建议 (`bbr.sh`, `init.sh`)
*   **当前问题**：用户可能不知道当前系统是否需要优化。
*   **建议**：
    *   脚本启动时自动列出当前系统状态概览（如：当前拥塞控制算法、内核版本、服务运行状态、检测到的 IP 地区等），并智能推荐是否需要执行 BBR 脚本或更新特定组件。

---

## 优先级建议

1.  **P0 (关键)**: 实现配置修改前的**备份与回滚**机制，引入二进制文件的**Checksum 校验**。
2.  **P1 (重要)**: 实现**系统用户隔离**运行服务，提高安全性。
3.  **P2 (优化)**: 拆分 `core.sh`，实现代码解耦。
